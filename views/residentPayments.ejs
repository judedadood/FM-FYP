<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    nav {
      background: #003366;
      padding: 12px 25px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo { font-weight: bold; font-size: 20px; }
    nav ul { list-style: none; display: flex; gap: 18px; margin:0; padding:0; }
    nav a { color:#fff; text-decoration:none; font-size:14px; }
    nav a:hover { text-decoration:underline; }
  </style>
</head>
<body class="bg-light">

<nav>
  <div class="logo">Condo Management System</div>
  <ul>
    <li><a href="/announcements">Announcements</a></li>
    <li><a href="/facilities">Facilities</a></li>
    <li><a href="/maintenance-request">Maintenance</a></li>
    <li><a href="/resident/payments">Payments</a></li>
    <li><a href="/logout">Logout</a></li>
  </ul>
</nav>

<div class="container my-5" style="max-width: 1100px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">My Payments</h2>
    <div class="text-muted">Hi, <%= userName || "Resident" %></div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Unit</th>
              <th>Period</th>
              <th>Condo</th>
              <th>Carpark</th>
              <th>Total</th>
              <th>Invoice Status</th>
              <th>Payment Status</th>
              <th style="width: 420px;">Submit Payment</th>
            </tr>
          </thead>
          <tbody>
            <% if (!invoices || invoices.length === 0) { %>
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  No invoices found for your unit yet.
                </td>
              </tr>
            <% } %>

            <% (invoices || []).forEach(inv => { 
              const total = Number(inv.total_amount || 0);
              const condo = (inv.condo_fee === null || inv.condo_fee === undefined) ? "-" : `$${Number(inv.condo_fee).toFixed(2)}`;
              const carpark = (inv.carpark_fee === null || inv.carpark_fee === undefined) ? "-" : `$${Number(inv.carpark_fee).toFixed(2)}`;
              const periodStart = inv.period_start ? new Date(inv.period_start).toISOString().slice(0,10) : "";
              const periodEnd = inv.period_end ? new Date(inv.period_end).toISOString().slice(0,10) : "";

              const invBadge =
                inv.invoice_status === "Paid" ? "success" :
                inv.invoice_status === "Pending" ? "warning" : "secondary";

              const payBadge =
                inv.payment_status === "Approved" ? "success" :
                inv.payment_status === "Rejected" ? "danger" :
                inv.payment_status === "Pending" ? "warning" : "secondary";
            %>
              <tr>
                <td><strong><%= inv.unit_no %></strong></td>
                <td><%= periodStart %> â†’ <%= periodEnd %></td>
                <td><%= condo %></td>
                <td><%= carpark %></td>
                <td><strong>$<%= total.toFixed(2) %></strong></td>
                <td><span class="badge bg-<%= invBadge %>"><%= inv.invoice_status || "Unpaid" %></span></td>
                <td><span class="badge bg-<%= payBadge %>"><%= inv.payment_status || "No submission" %></span></td>
                <td>
                  <% if (inv.invoice_status === "Paid") { %>
                    <span class="text-muted">Paid</span>
                  <% } else { %>
                    <form action="/resident/payments/submit" method="POST" class="d-flex gap-2">
                      <input type="hidden" name="invoiceId" value="<%= inv.invoice_id %>">

                      <select class="form-select form-select-sm" name="method" required>
                        <option value="PayNow">PayNow</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Card">Card</option>
                      </select>

                      <input class="form-control form-control-sm" name="referenceNo" placeholder="Ref No (optional)">

                      <input class="form-control form-control-sm" name="amount" value="<%= total.toFixed(2) %>" required>

                      <button class="btn btn-sm btn-primary">Submit</button>
                    </form>

                    <div class="text-muted small mt-2">
                      After submission, admin will review and approve/reject.
                    </div>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
</body>
</html>
