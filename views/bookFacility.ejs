<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        nav {
            background: #003366;
            padding: 15px 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav .logo {
            font-size: 22px;
            font-weight: bold;
        }
        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
        }
        nav ul li a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav>
    <div class="logo">Condo Management System</div>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/announcements">Announcements</a></li>
        <li><a href="/facilities">Facilities</a></li>
        <li><a href="/maintenance-request">Maintenance Request</a></li>
    </ul>
</nav>

<!-- PAGE CONTENT -->
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Book <%= facility.name %></h2>

            <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <form action="/facilities/book" method="POST" class="card p-4 shadow-sm">

                <!-- IMPORTANT: submit facility_id only -->
                <input type="hidden" name="facility_id" value="<%= facility.facility_id %>">

                <!-- Display-only facility name -->
                <div class="mb-3">
                    <label class="form-label">Facility</label>
                    <input type="text" class="form-control" value="<%= facility.name %>" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Resident Name</label>
                    <input type="text" name="resident_name" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Unit Number</label>
                    <input type="text" class="form-control" value="<%= unitNo || 'N/A' %>" disabled readonly>
                    <div class="form-text">Your unit number (auto-filled from system)</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Contact Number</label>
                    <input type="text" name="contact_number" class="form-control" required>
                </div>

                <%
                  // slots list
                  const slots = [
                    "09:00 AM - 11:00 AM",
                    "11:00 AM - 01:00 PM",
                    "01:00 PM - 03:00 PM",
                    "03:00 PM - 05:00 PM",
                    "05:00 PM - 07:00 PM"
                  ];

                  // capacity from DB (BBQ=1, Gym=5, Function Room=3)
                  const capacity = facility.capacity || 1;
                %>

                <!-- Booking Date (reload page to show remaining slots for that date) -->
                <div class="mb-3">
                    <label class="form-label">Booking Date</label>
                    <input
                        type="date"
                        name="booking_date"
                        class="form-control"
                        value="<%= selectedDate %>"
                        required
                        onchange="window.location.href='/facilities/book/<%= facility.facility_id %>?date=' + this.value"
                    >
                </div>

                <!-- Time Slot (disable if FULL) -->
                <div class="mb-3">
                    <label class="form-label">Time Slot</label>
                    <select name="time_slot" class="form-control" required>
                        <option value="">-- Select a time slot --</option>

                        <% slots.forEach(slot => {
                            const booked = bookedMap && bookedMap[slot] ? bookedMap[slot] : 0;
                            const remaining = capacity - booked;
                            const isFull = remaining <= 0;
                        %>
                            <option value="<%= slot %>" <%= isFull ? "disabled" : "" %>>
                                <%= slot %> (<%= remaining %> left)<%= isFull ? " - FULL" : "" %>
                            </option>
                        <% }) %>

                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Confirm Booking</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
