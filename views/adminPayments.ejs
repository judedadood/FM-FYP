<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    nav {
      background: #003366;
      padding: 12px 25px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo { font-weight: bold; font-size: 20px; }
    nav ul { list-style: none; display: flex; gap: 18px; margin:0; padding:0; }
    nav a { color:#fff; text-decoration:none; font-size:14px; }
    nav a:hover { text-decoration:underline; }
  </style>
</head>
<body class="bg-light">

<nav>
  <div class="logo">Condo Management System</div>
  <ul>
    <li><a href="/admin">Admin Dashboard</a></li>
    <li><a href="/admin/bookings">Bookings</a></li>
    <li><a href="/admin/maintenance">Maintenance</a></li>
    <li><a href="/admin/events">Events</a></li>
    <li><a href="/admin/payments">Payments</a></li>
    <li><a href="/logout">Logout</a></li>
  </ul>
</nav>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Manage Payments</h2>
    <div class="text-muted">Logged in as: <%= userName || "Admin" %></div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Unit</th>
              <th>Period</th>
              <th>Condo</th>
              <th>Carpark</th>
              <th>Total</th>
              <th>Method</th>
              <th>Ref</th>
              <th>Status</th>
              <th style="width: 220px;">Action</th>
            </tr>
          </thead>
          <tbody>
            <% if (!payments || payments.length === 0) { %>
              <tr>
                <td colspan="10" class="text-center text-muted py-4">No payment submissions yet.</td>
              </tr>
            <% } %>

            <% (payments || []).forEach(p => { 
              const total = Number(p.total_amount || 0);
              const condo = (p.condo_fee === null || p.condo_fee === undefined) ? "-" : `$${Number(p.condo_fee).toFixed(2)}`;
              const carpark = (p.carpark_fee === null || p.carpark_fee === undefined) ? "-" : `$${Number(p.carpark_fee).toFixed(2)}`;
              const paidAt = p.paid_at ? new Date(p.paid_at).toLocaleString("en-SG") : "-";
              const periodStart = p.period_start ? new Date(p.period_start).toISOString().slice(0,10) : "";
              const periodEnd = p.period_end ? new Date(p.period_end).toISOString().slice(0,10) : "";
              const badge =
                p.payment_status === "Approved" ? "success" :
                p.payment_status === "Rejected" ? "danger" : "warning";
            %>
              <tr>
                <td><%= paidAt %></td>
                <td><strong><%= p.unit_no %></strong></td>
                <td><%= periodStart %> â†’ <%= periodEnd %></td>
                <td><%= condo %></td>
                <td><%= carpark %></td>
                <td><strong>$<%= total.toFixed(2) %></strong></td>
                <td><%= p.method %></td>
                <td><%= p.reference_no || "-" %></td>
                <td>
                  <span class="badge bg-<%= badge %>"><%= p.payment_status %></span>
                </td>
                <td>
                  <form action="/admin/payments/update" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="paymentId" value="<%= p.payment_id %>">
                    <select class="form-select form-select-sm" name="action" required>
                      <option value="Approved">Approve</option>
                      <option value="Rejected">Reject</option>
                    </select>
                    <button class="btn btn-sm btn-dark">Update</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="text-muted small mt-2">
        Note: Only submissions in the <code>payments</code> table will appear here.
      </div>
    </div>
  </div>
</div>

</body>
</html>
